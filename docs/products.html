
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ALPHAGEN COMPANY.LTD</title>
  <style>
    /* ... [All your CSS remains unchanged] ... */
  </style>
</head>
<body>
  <!-- [All your existing HTML remains unchanged] -->

  <script>
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const favorites = new Set(JSON.parse(localStorage.getItem("favorites")) || []);
    let products = [];

    document.getElementById("cartIcon").addEventListener("click", () => {
      const dropdown = document.getElementById("cartDropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });

    document.getElementById("favoriteIcon").addEventListener("click", () => {
      const dropdown = document.getElementById("favoriteDropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });

    document.getElementById("offersIcon").addEventListener("click", () => {
      window.location.href = "offer.html";
    });

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      const existing = cart.find(p => p.id === productId);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartUI();
    }

    function toggleFavorite(productId) {
      if (favorites.has(productId)) {
        favorites.delete(productId);
      } else {
        favorites.add(productId);
      }
      localStorage.setItem("favorites", JSON.stringify([...favorites]));
      updateFavoriteUI();
    }

    // ✅ FIXED updateCartUI
    function updateCartUI() {
      const cartCount = document.getElementById("cartCount");
      const cartItemsContainer = document.getElementById("cartItems");
      const cartTotalEl = document.getElementById("cartTotal");
      let totalItems = 0;
      let totalPrice = 0;

      cartItemsContainer.innerHTML = "";

      cart.forEach((item, index) => {
        const price = parseFloat(item.price) || 0;
        const itemTotal = item.quantity * price;
        totalItems += item.quantity;
        totalPrice += itemTotal;

        const div = document.createElement("div");
        div.className = "dropdown-item";
        div.textContent = `${index + 1}. ${item.name} x${item.quantity} - Ksh ${itemTotal.toFixed(2)}`;
        cartItemsContainer.appendChild(div);
      });

      cartCount.textContent = totalItems;
      cartTotalEl.textContent = isNaN(totalPrice) ? "0" : totalPrice.toFixed(2);
    }

    function updateFavoriteUI() {
      const container = document.getElementById("favoriteItems");
      container.innerHTML = "";
      let i = 1;
      favorites.forEach(id => {
        const product = products.find(p => p.id === id);
        if (product) {
          const div = document.createElement("div");
          div.className = "dropdown-item";
          div.textContent = `${i++}. ${product.name}`;
          container.appendChild(div);
        }
      });
    }

    window.addEventListener("DOMContentLoaded", async () => {
      speakIntro();
      await fetchProducts();
      setupFilters();
      updateCartUI();
      updateFavoriteUI();
    });

    function speakIntro() {
      const message = "Welcome to our products page. We have all kinds of electronics and electricals you are in need of, all brands of your taste. Scroll down or search in the search bar for a specific product.";
      if (speechSynthesis.speaking) speechSynthesis.cancel();
      const speech = new SpeechSynthesisUtterance(message);
      speechSynthesis.speak(speech);
    }

    window.addEventListener("beforeunload", () => {
      if (speechSynthesis.speaking) speechSynthesis.cancel();
    });

    async function fetchProducts() {
      try {
        const res = await fetch("https://heyz-electricals-and-electronis-website-2.onrender.com/api/products");
        if (!res.ok) throw new Error(`Failed to fetch: ${res.status}`);
        products = (await res.json()).map(p => ({ ...p, id: p._id }));
        populateFilterOptions();
        renderProducts(products);
      } catch (err) {
        document.getElementById("productsContainer").innerHTML = `<p style="color:red;">Error loading products: ${err.message}</p>`;
      }
    }

    function populateFilterOptions() {
      const categories = new Set(products.map(p => p.category));
      const brands = new Set(products.map(p => p.brand));
      const catSelect = document.getElementById("categoryFilter");
      const brandSelect = document.getElementById("brandFilter");
      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        catSelect.appendChild(option);
      });
      brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });
    }

    function setupFilters() {
      document.getElementById("searchInput").addEventListener("input", filterAndRender);
      document.getElementById("categoryFilter").addEventListener("change", filterAndRender);
      document.getElementById("brandFilter").addEventListener("change", filterAndRender);
    }

    function filterAndRender() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const selectedCategory = document.getElementById("categoryFilter").value;
      const selectedBrand = document.getElementById("brandFilter").value;
      const filtered = products.filter(p =>
        (!search || p.name.toLowerCase().includes(search) || p.description.toLowerCase().includes(search)) &&
        (!selectedCategory || p.category === selectedCategory) &&
        (!selectedBrand || p.brand === selectedBrand)
      );
      renderProducts(filtered);
    }

    function renderProducts(list) {
      const container = document.getElementById("productsContainer");
      container.innerHTML = list.length ? "" : "<p>No products found.</p>";
      list.forEach(product => {
        const imageUrl = product.images?.[0] || "https://via.placeholder.com/200x150?text=No+Image";
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${imageUrl}" alt="${product.name}">
          <h3>${product.name}</h3>
          <p>${product.description}</p>
          <span>Price: Ksh ${product.price}</span>
          <span>Quantity: ${product.quantity}</span>
          <div style="margin-top:10px;">
            <button onclick="addToCart('${product.id}')" class="kat">Add to Cart</button>
            <button onclick="toggleFavorite('${product.id}')" class="hat">❤️</button>
            <button onclick="window.location.href='product.html?id=${product.id}'" class="viuu">View Product</button>
          </div>
        `;
        container.appendChild(card);
      });
    }
  </script>
</body>
</html>
